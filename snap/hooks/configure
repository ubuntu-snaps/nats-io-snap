#!/bin/sh -e

if [ -z "$(snapctl get host)" ]; then
	snapctl set host="0.0.0.0";
fi

if [ -z "$(snapctl get port)" ]; then
	snapctl set port="4222";
fi

if [ -z "$(snapctl get http-port)" ]; then
	snapctl set http-port="8222";
fi

if [ -z "$(snapctl get jetstream.max-mem)" ]; then
	snapctl set jetstream.max-mem="1G";
fi

if [ -z "$(snapctl get jetstream.max-file)" ]; then
	snapctl set jetstream.max-file="10G";
fi

if [ -z "$(snapctl get auth.token)" ]; then
	snapctl set auth.token="";
fi

if [ -z "$(snapctl get auth.username)" ]; then
	snapctl set auth.username="";
fi

if [ -z "$(snapctl get auth.password)" ]; then
	snapctl set auth.password="";
fi

cat > $SNAP_DATA/nats-server.conf <<EOF
host: $(snapctl get host)
port: $(snapctl get port)
http_port: $(snapctl get http-port)
log_file: $SNAP_DATA/nats-server.log
jetstream {
  store_dir: $SNAP_DATA/store
  max_mem: $(snapctl get jetstream.max-mem)
  max_file: $(snapctl get jetstream.max-file)
}
authorization {
  token: "$(snapctl get auth.token)"
  username: "$(snapctl get auth.username)"
  password: "$(snapctl get auth.password)"
}
EOF

snapctl restart "$SNAP_INSTANCE_NAME"
